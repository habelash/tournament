{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{ --brand-blue:#0b3d91; --brand-yellow:#ffcc00; --accent-white:#ffffff; }
  .brand-header{ background:var(--brand-blue); color:var(--accent-white); }
  .btn-brand{ background:var(--brand-yellow); color:#000; border:none; }
  .card-brand{ border-left:6px solid var(--brand-yellow); }
</style>

<div id="page" class="container py-4" data-tournament-id="{{ tournament.id }}">
  <div class="d-flex justify-content-between align-items-center mb-3 brand-header p-3 rounded">
    <div>
      <h3 class="mb-0">Start Game Category</h3>
      <small>Tournament: <strong>{{ tournament.name }}</strong></small>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card card-brand mb-3">
        <div class="card-body">
          <h5 class="card-title">Categories</h5>
          <p class="text-muted">Select which category you want to start for this tournament.</p>

          <div class="list-group" id="categories-list">
            {% for category in categories %}
              <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                   data-category-id="{{ category.id }}" data-category-slug="{{ category.slug }}">
                <div>
                  <strong>{{ category.category }}</strong>
                  <div class="small text-muted">{{ category.description|default:"No description" }}</div>
                </div>

                <div class="d-flex gap-2 align-items-center">
                  {% if category.is_active %}
                    <span class="badge bg-success">Active</span>
                    <button class="btn btn-sm btn-secondary" disabled>Started</button>
                  {% else %}
                    <span class="badge bg-secondary">Not started</span>

                    <!-- single start button (opens modal). type="button" prevents accidental submit -->
                    <button type="button"
                            class="btn btn-sm btn-brand start-category-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmStartModal"
                            data-category-id="{{ category.id }}"
                            data-category-name="{{ category.category }}"
                            data-category-slug="{{ category.slug }}">
                      Start
                    </button>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <div class="alert alert-warning">No categories found for this tournament.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Confirmation Modal -->
      <div class="modal fade" id="confirmStartModal" tabindex="-1" aria-labelledby="confirmStartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmStartModalLabel">Confirm Start</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to start the category <strong id="modal-category-name"></strong>?
            </div>
            <div class="modal-footer">
              <!-- Normal POST form; submission will be handled by your Django view -->
              <form id="confirmStartForm" method="post" action="{% url 'start_tournament_category' tournament.id %}">
                {% csrf_token %}
                <input type="hidden" name="category_id" id="modal-category-id" value="">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Yes, Start</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div id="status-area" class="mt-3"></div>
    </div>

    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-body">
          <h6>Quick actions</h6>
          <p class="small text-muted">Useful shortcuts for tournament organisers.</p>
          <button id="refresh-btn" class="btn btn-outline-secondary btn-sm">Refresh</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('Template JS loaded');

    const confirmModalEl = document.getElementById('confirmStartModal');
    if (!confirmModalEl) { console.error('confirmStartModal element missing'); return; }

    // Show.bs.modal event gives the button that triggered the modal in event.relatedTarget
    confirmModalEl.addEventListener('show.bs.modal', function (event) {
      const triggerBtn = event.relatedTarget;
      if (!triggerBtn) { console.warn('Modal opened without relatedTarget'); return; }

      const catId = triggerBtn.getAttribute('data-category-id');
      const catName = triggerBtn.getAttribute('data-category-name') || triggerBtn.getAttribute('data-category-slug');

      console.log('Opening confirm modal for category:', { catId, catName });

      document.getElementById('modal-category-id').value = catId || '';
      document.getElementById('modal-category-name').textContent = catName || 'â€”';
    });

    // Simple UI helper for refresh button
    const refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) refreshBtn.addEventListener('click', () => location.reload());
  });
</script>

{% endblock %}
